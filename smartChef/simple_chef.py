"""
SmartChef ç®€åŒ–ç‰ˆ - ç›´æ¥è°ƒç”¨OpenAI API
"""
import os
import requests
import json
import time
from datetime import datetime
from dotenv import load_dotenv
from openai import OpenAI

# åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()

# åˆå§‹åŒ–OpenAIå®¢æˆ·ç«¯
client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

# ç¡®ä¿recipesç›®å½•å­˜åœ¨
os.makedirs("recipes", exist_ok=True)

def generate_recipe(ingredients, cuisine_type, special_requirements=None):
    """ä½¿ç”¨OpenAI APIç”Ÿæˆé£Ÿè°±"""
    
    print(f"ğŸ“‹ ç”Ÿæˆ{cuisine_type}é£Ÿè°±")
    print(f"é£Ÿæ: {ingredients}")
    if special_requirements:
        print(f"ç‰¹æ®Šè¦æ±‚: {special_requirements}")
    
    # æ„å»ºæç¤ºè¯
    prompt = f"""è¯·æ ¹æ®ä»¥ä¸‹é£Ÿæåˆ›å»ºä¸€ä¸ªè¯¦ç»†çš„{cuisine_type}é£Ÿè°±:
    
    å¯ç”¨é£Ÿæ: {ingredients}
    
    {'ç‰¹æ®Šè¦æ±‚: ' + special_requirements if special_requirements else ''}
    
    è¯·æä¾›:
    1. æœ‰åˆ›æ„çš„èœå
    2. è¯¦ç»†çš„é£Ÿææ¸…å•(åŒ…æ‹¬æ•°é‡)
    3. å‡†å¤‡å’Œçƒ¹é¥ªçš„è¯¦ç»†æ­¥éª¤
    4. çƒ¹é¥ªæŠ€å·§å’Œçªé—¨
    5. é¢„è®¡å‡†å¤‡å’Œçƒ¹é¥ªæ—¶é—´
    
    è¯·ä½¿ç”¨Markdownæ ¼å¼ï¼Œå¹¶ç¡®ä¿é£Ÿè°±ç¬¦åˆ{cuisine_type}çš„é£æ ¼ã€‚
    """
    
    try:
        # è°ƒç”¨OpenAI API
        print("ğŸ¤– æ­£åœ¨è°ƒç”¨OpenAI APIç”Ÿæˆé£Ÿè°±...")
        start_time = time.time()
        
        response = client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[
                {"role": "system", "content": "ä½ æ˜¯ä¸€ä½ä¸“ä¸šå¨å¸ˆï¼Œæ“…é•¿æ ¹æ®ç°æœ‰é£Ÿæåˆ›é€ ç¾å‘³çš„é£Ÿè°±ã€‚"},
                {"role": "user", "content": prompt}
            ],
            temperature=0.7,
            max_tokens=1500
        )
        
        # æå–ç”Ÿæˆçš„é£Ÿè°±
        recipe_markdown = response.choices[0].message.content.strip()
        
        # è®¡ç®—å¹¶æ˜¾ç¤ºAPIè°ƒç”¨æ—¶é—´
        elapsed_time = time.time() - start_time
        print(f"âœ… é£Ÿè°±ç”Ÿæˆå®Œæˆ! (ç”¨æ—¶: {elapsed_time:.2f}ç§’)")
        
        return recipe_markdown
        
    except Exception as e:
        print(f"âŒ OpenAI APIè°ƒç”¨å¤±è´¥: {str(e)}")
        print("âš ï¸ ä½¿ç”¨é¢„è®¾çš„æ¨¡æ‹Ÿæ•°æ®ä½œä¸ºæ›¿ä»£...")
        
        # è¿”å›æ¨¡æ‹Ÿæ•°æ®
        return generate_mock_recipe(ingredients, cuisine_type, special_requirements)

def generate_mock_recipe(ingredients, cuisine_type, special_requirements=None):
    """å½“APIè°ƒç”¨å¤±è´¥æ—¶ç”Ÿæˆæ¨¡æ‹Ÿé£Ÿè°±æ•°æ®"""
    
    # è§£æé£Ÿæ
    ingredient_list = [i.strip() for i in ingredients.split('ï¼Œ')]
    
    # æ ¹æ®é£Ÿæå’Œèœç³»é€‰æ‹©åˆé€‚çš„æ¨¡æ‹Ÿé£Ÿè°±
    if "é¸¡è›‹" in ingredient_list:
        if cuisine_type == "ä¸­é¤":
            if "ç‰›å¥¶" in ingredient_list:
                return """# ç‰›å¥¶è’¸è›‹

## é£Ÿæ
- é¸¡è›‹ 3ä¸ª
- ç‰›å¥¶ 200ml
- ç› 1/4èŒ¶åŒ™
- è‘±èŠ± é€‚é‡ï¼ˆè£…é¥°ç”¨ï¼‰

## æ­¥éª¤
1. å°†é¸¡è›‹æ‰“å…¥ç¢—ä¸­ï¼Œæ…æ‹Œå‡åŒ€ä½†ä¸è¦èµ·æ³¡
2. ç‰›å¥¶åŠ çƒ­è‡³æ¸©çƒ­ï¼ˆä¸è¦ç…®æ²¸ï¼‰
3. å°†æ¸©çƒ­çš„ç‰›å¥¶æ…¢æ…¢å€’å…¥è›‹æ¶²ä¸­ï¼Œè¾¹å€’è¾¹æ…æ‹Œ
4. åŠ å…¥ç›è°ƒå‘³ï¼Œç»§ç»­æ…æ‹Œå‡åŒ€
5. å°†è›‹å¥¶æ¶²è¿‡ç­›ï¼Œå»é™¤æ‚è´¨
6. å°†è›‹å¥¶æ¶²å€’å…¥è€çƒ­å®¹å™¨ä¸­
7. ä¸Šé”…è’¸15åˆ†é’Ÿï¼ˆæ°´å¼€åä¸­å°ç«ï¼‰
8. å‡ºé”…å‰æ’’ä¸Šè‘±èŠ±ç‚¹ç¼€

## çƒ¹é¥ªæŠ€å·§
- è’¸çš„è¿‡ç¨‹ä¸­ä¸è¦æ­ç›–ï¼Œé¿å…è¡¨é¢ä¸å¹³æ•´
- ç­›è›‹æ¶²å¯ä»¥è®©è’¸è›‹æ›´åŠ ç»†è…»
- ç‰›å¥¶æ¸©åº¦ä¸è¦å¤ªé«˜ï¼Œé¿å…è›‹æ¶²æå‰å‡å›º
- è’¸å¥½åå¯ä»¥æ»´å‡ æ»´é¦™æ²¹æé¦™

## æ—¶é—´
- å‡†å¤‡æ—¶é—´ï¼š10åˆ†é’Ÿ
- çƒ¹é¥ªæ—¶é—´ï¼š15åˆ†é’Ÿ
- æ€»æ—¶é—´ï¼š25åˆ†é’Ÿ

## è¥å…»ä¿¡æ¯
è¿™é“ç‰›å¥¶è’¸è›‹çƒ­é‡è¾ƒä½ï¼Œè›‹ç™½è´¨å«é‡ä¸°å¯Œï¼Œéå¸¸é€‚åˆä½å¡é¥®é£Ÿéœ€æ±‚ã€‚"""
            else:
                return """# è‘±èŠ±è’¸è›‹

## é£Ÿæ
- é¸¡è›‹ 3ä¸ª
- æ¸…æ°´ 240ml
- ç› 1/4èŒ¶åŒ™
- è‘±èŠ± é€‚é‡
- é¦™æ²¹ å°‘è®¸

## æ­¥éª¤
1. å°†é¸¡è›‹æ‰“å…¥ç¢—ä¸­ï¼Œç”¨ç­·å­æ…æ‹Œå‡åŒ€
2. åŠ å…¥æ¸…æ°´å’Œç›ï¼Œæ¯”ä¾‹çº¦ä¸º1:1.3ï¼ˆè›‹æ¶²:æ°´ï¼‰
3. ç»§ç»­æ…æ‹Œå‡åŒ€ï¼Œç„¶åè¿‡ç­›ä¸€æ¬¡
4. å°†è›‹æ¶²å€’å…¥ç¢—ä¸­ï¼Œæ’’ä¸Šè‘±èŠ±
5. ä¸Šé”…è’¸10-15åˆ†é’Ÿï¼ˆæ°´å¼€åè½¬ä¸­å°ç«ï¼‰
6. å‡ºé”…åæ»´å‡ æ»´é¦™æ²¹æé¦™

## çƒ¹é¥ªæŠ€å·§
- è’¸çš„è¿‡ç¨‹ä¸­ä¸è¦æ­ç›–ï¼Œé¿å…è¡¨é¢ä¸å¹³æ•´
- ç­›è›‹æ¶²å¯ä»¥è®©è’¸è›‹æ›´åŠ ç»†è…»
- æ°´æ¸©ä¸è¦å¤ªçƒ«ï¼Œé¿å…è›‹æ¶²æå‰å‡å›º
- å¯ä»¥åœ¨ç¢—åº•é“ºä¸€å±‚ä¿é²œè†œï¼Œæ–¹ä¾¿å–å‡º

## æ—¶é—´
- å‡†å¤‡æ—¶é—´ï¼š5åˆ†é’Ÿ
- çƒ¹é¥ªæ—¶é—´ï¼š15åˆ†é’Ÿ
- æ€»æ—¶é—´ï¼š20åˆ†é’Ÿ

## è¥å…»ä¿¡æ¯
è¿™é“è‘±èŠ±è’¸è›‹çƒ­é‡ä½ï¼Œè›‹ç™½è´¨å«é‡ä¸°å¯Œï¼Œæ˜¯ç†æƒ³çš„ä½å¡é£Ÿå“ã€‚"""
        elif cuisine_type == "è¥¿é¤":
            return """# ä½å¡ç‰›å¥¶æ³•å¼ç‚’è›‹

## é£Ÿæ
- é¸¡è›‹ 2ä¸ª
- ç‰›å¥¶ 50ml
- é»‘èƒ¡æ¤’ å°‘è®¸
- ç› å°‘è®¸
- æ©„æ¦„æ²¹ 5ml
- æ¬§èŠ¹ å°‘è®¸ï¼ˆè£…é¥°ç”¨ï¼‰

## æ­¥éª¤
1. å°†é¸¡è›‹æ‰“å…¥ç¢—ä¸­ï¼ŒåŠ å…¥ç‰›å¥¶ã€ç›å’Œé»‘èƒ¡æ¤’
2. ç”¨å‰å­è½»è½»æ…æ‹Œå‡åŒ€
3. å¹³åº•é”…å°ç«åŠ çƒ­ï¼Œå€’å…¥æ©„æ¦„æ²¹
4. å€’å…¥è›‹æ¶²ï¼Œç”¨æ©¡çš®é“²ä¸åœåœ°æ…åŠ¨
5. å½“è›‹æ¶²å˜å¾—æµ“ç¨ ä½†ä»ç„¶æ¹¿æ¶¦æ—¶ï¼Œå…³ç«
6. ä½™çƒ­ä¼šç»§ç»­ç…®ç†Ÿè›‹æ¶²ï¼Œä¿æŒå…¶æŸ”å«©çš„å£æ„Ÿ
7. ç››å‡ºè£…ç›˜ï¼Œæ’’ä¸Šæ¬§èŠ¹ç‚¹ç¼€

## çƒ¹é¥ªæŠ€å·§
- å…¨ç¨‹ä½¿ç”¨å°ç«ï¼Œé¿å…ç‚’è›‹å˜è€
- ä¸åœåœ°æ…åŠ¨å¯ä»¥è®©è›‹æ¶²å½¢æˆç»†å°çš„è›‹èŠ±
- è›‹æ¶²7åˆ†ç†Ÿæ—¶å°±å¯ä»¥å…³ç«ï¼Œä½™çƒ­ä¼šç»§ç»­ç…®ç†Ÿ
- å¯ä»¥åŠ å…¥å°‘é‡åˆ‡ç¢çš„è”¬èœæå‡è¥å…»ä»·å€¼

## æ—¶é—´
- å‡†å¤‡æ—¶é—´ï¼š5åˆ†é’Ÿ
- çƒ¹é¥ªæ—¶é—´ï¼š3-5åˆ†é’Ÿ
- æ€»æ—¶é—´ï¼š10åˆ†é’Ÿ

## è¥å…»ä¿¡æ¯
è¿™é“æ³•å¼ç‚’è›‹çƒ­é‡è¾ƒä½ï¼Œç‰¹åˆ«æ˜¯ä½¿ç”¨å°‘é‡çš„æ©„æ¦„æ²¹ä»£æ›¿é»„æ²¹ï¼Œæ›´é€‚åˆä½å¡é¥®é£Ÿéœ€æ±‚ã€‚"""
    
    elif "ç‰›è‚‰" in ingredient_list:
        if cuisine_type == "ä¸­é¤":
            return """# ä½è„‚æ¸…ç‚–ç‰›è‚‰æ±¤

## é£Ÿæ
- ç²¾ç˜¦ç‰›è‚‰ 300å…‹
- å§œç‰‡ 5ç‰‡
- è‘±æ®µ 3æ®µ
- å…«è§’ 1ä¸ª
- æ–™é…’ 1æ±¤åŒ™
- ç› é€‚é‡
- æ¸…æ°´ 1500ml

## æ­¥éª¤
1. ç‰›è‚‰æ´—å‡€ï¼Œåˆ‡æˆ4å˜ç±³è§æ–¹çš„å—
2. é”…ä¸­åŠ å…¥æ¸…æ°´ï¼Œæ”¾å…¥ç‰›è‚‰ï¼Œå¤§ç«ç…®æ²¸
3. æ’‡å»æµ®æ²«ï¼ŒåŠ å…¥å§œç‰‡ã€è‘±æ®µã€å…«è§’å’Œæ–™é…’
4. è½¬å°ç«æ…¢ç‚–1.5å°æ—¶ï¼Œç›´è‡³ç‰›è‚‰è½¯çƒ‚
5. åŠ å…¥é€‚é‡ç›è°ƒå‘³å³å¯

## çƒ¹é¥ªæŠ€å·§
- é€‰æ‹©ç²¾ç˜¦ç‰›è‚‰éƒ¨ä½ï¼Œå‡å°‘è„‚è‚ªæ‘„å…¥
- ç‚–ç…®æ—¶é—´è¦è¶³å¤Ÿé•¿ï¼Œæ‰èƒ½ä½¿ç‰›è‚‰è½¯çƒ‚
- å¯ä»¥æå‰ä¸€å¤©ç‚–å¥½ï¼Œæ”¾å†·åå»é™¤è¡¨é¢å‡å›ºçš„æ²¹è„‚ï¼Œå†åŠ çƒ­é£Ÿç”¨
- ä¸è¦æ·»åŠ æ²¹è„‚ï¼Œåˆ©ç”¨ç‰›è‚‰æœ¬èº«çš„é²œå‘³

## æ—¶é—´
- å‡†å¤‡æ—¶é—´ï¼š15åˆ†é’Ÿ
- çƒ¹é¥ªæ—¶é—´ï¼š90åˆ†é’Ÿ
- æ€»æ—¶é—´ï¼š105åˆ†é’Ÿ

## è¥å…»ä¿¡æ¯
æ¸…ç‚–ç‰›è‚‰æ±¤ä¸æ·»åŠ é¢å¤–æ²¹è„‚ï¼Œé€‰ç”¨ç²¾ç˜¦ç‰›è‚‰éƒ¨ä½ï¼Œæ˜¯ä¸€é“ä½è„‚é«˜è›‹ç™½çš„å¥åº·èœå“ã€‚"""
    
    # é»˜è®¤è¿”å›é€šç”¨é£Ÿè°±
    return f"""# ç®€æ˜“{cuisine_type}å¥åº·é¤

## é£Ÿæ
{', '.join('- ' + ing for ing in ingredient_list)}
- ç› é€‚é‡
- é»‘èƒ¡æ¤’ é€‚é‡

## æ­¥éª¤
1. å‡†å¤‡æ‰€æœ‰é£Ÿæï¼Œæ¸…æ´—å¹²å‡€
2. æ ¹æ®é£Ÿæç‰¹æ€§ï¼Œé€‰æ‹©åˆé€‚çš„çƒ¹é¥ªæ–¹å¼
3. æ§åˆ¶ç”¨æ²¹é‡ï¼Œå°½é‡é‡‡ç”¨è’¸ã€ç…®ã€ç‚–ç­‰ä½è„‚çƒ¹é¥ªæ–¹å¼
4. é€‚é‡è°ƒå‘³ï¼Œæ³¨é‡é£Ÿææœ¬èº«çš„é²œå‘³

## çƒ¹é¥ªæŠ€å·§
- å‡å°‘æ²¹ç›ç”¨é‡ï¼Œæœ‰åŠ©äºé™ä½çƒ­é‡æ‘„å…¥
- ä¿æŒé£Ÿæçš„åŸæ±åŸå‘³ï¼Œå°‘åŠ è°ƒå‘³æ–™
- å¯ä»¥æ·»åŠ å„ç§é¦™è‰å¢é¦™ï¼Œå‡å°‘ç›çš„ä½¿ç”¨

## æ—¶é—´
- å‡†å¤‡æ—¶é—´ï¼š10åˆ†é’Ÿ
- çƒ¹é¥ªæ—¶é—´ï¼š20åˆ†é’Ÿ
- æ€»æ—¶é—´ï¼š30åˆ†é’Ÿ

## è¥å…»ä¿¡æ¯
è¿™æ˜¯ä¸€é“ç¬¦åˆä½å¡è¦æ±‚çš„å¥åº·é£Ÿè°±ï¼Œæ³¨é‡ä¿ç•™é£Ÿæè¥å…»çš„åŒæ—¶ï¼Œå‡å°‘ä¸å¿…è¦çš„çƒ­é‡æ‘„å…¥ã€‚"""

def generate_image(dish_name):
    """ä½¿ç”¨Unsplashç”Ÿæˆé£Ÿç‰©å›¾ç‰‡URL (å› ä¸ºOpenAIå›¾åƒç”Ÿæˆæ˜¯ä»˜è´¹çš„)"""
    
    # ç®€å•èµ·è§ï¼Œä½¿ç”¨Unsplashéšæœºå›¾ç‰‡API
    dish_name_escaped = dish_name.replace(" ", "+")
    image_url = f"https://source.unsplash.com/random/800x600/?food,{dish_name_escaped}"
    
    return image_url

def save_recipe(recipe_content, recipe_name=None):
    """ä¿å­˜é£Ÿè°±åˆ°æ–‡ä»¶"""
    
    # å¦‚æœæ²¡æœ‰æä¾›èœåï¼Œå°è¯•ä»å†…å®¹ä¸­æå–
    if not recipe_name:
        # å°è¯•ä»markdownçš„æ ‡é¢˜ä¸­æå–èœå
        lines = recipe_content.split('\n')
        for line in lines:
            if line.startswith('# '):
                recipe_name = line[2:].strip()
                break
        
        # å¦‚æœä»ç„¶æ²¡æœ‰èœåï¼Œä½¿ç”¨é»˜è®¤åç§°
        if not recipe_name:
            recipe_name = "ç¾å‘³é£Ÿè°±"
    
    print(f"ğŸ’¾ æ­£åœ¨ä¿å­˜é£Ÿè°±: {recipe_name}")
    
    # åˆ›å»ºæ–‡ä»¶å
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    safe_name = recipe_name.replace(" ", "_").replace("/", "_").replace("\\", "_")
    filename = f"recipes/{safe_name}_{timestamp}.md"
    
    # æ·»åŠ å…ƒæ•°æ®
    metadata = f"""---
name: {recipe_name}
created_at: {timestamp}
tags: [AIç”Ÿæˆ]
---

"""
    
    # è·å–èœåå¯¹åº”çš„å›¾ç‰‡URL
    image_url = generate_image(recipe_name)
    
    # æ·»åŠ å›¾ç‰‡åˆ°é£Ÿè°±æœ«å°¾
    recipe_with_image = recipe_content + f"\n\n![{recipe_name}]({image_url})\n"
    
    # ä¿å­˜åˆ°æ–‡ä»¶
    with open(filename, "w", encoding="utf-8-sig") as f:
        f.write(metadata + recipe_with_image)
    
    print(f"âœ… é£Ÿè°±å·²ä¿å­˜è‡³: {filename}")
    return filename

def main():
    """ä¸»å‡½æ•°"""
    print("=" * 50)
    print("æ¬¢è¿ä½¿ç”¨ SmartChef - æ™ºèƒ½é£Ÿè°±åŠ©æ‰‹ (ç®€åŒ–ç‰ˆ)")
    print("=" * 50)
    
    # è·å–ç”¨æˆ·è¾“å…¥
    print("\nè¯·è¾“å…¥æ‚¨å¯ç”¨çš„é£Ÿæ (ç”¨é€—å·åˆ†éš”):")
    ingredients = input("> ")
    
    print("\nè¯·é€‰æ‹©èœç³»ç±»å‹ (å¦‚ä¸­é¤ã€è¥¿é¤ã€æ—¥å¼ç­‰):")
    cuisine_type = input("> ")
    
    print("\nè¯·è¾“å…¥ç‰¹æ®Šè¦æ±‚ (å¯é€‰ï¼Œå¦‚åè¾£ã€ä½å¡è·¯é‡Œç­‰):")
    special_requirements = input("> ")
    if not special_requirements.strip():
        special_requirements = None
    
    print("\n" + "=" * 50)
    print("æ­£åœ¨ç”Ÿæˆæ‚¨çš„ä¸“å±é£Ÿè°±ï¼Œè¯·ç¨å€™...")
    print("=" * 50 + "\n")
    
    # ç”Ÿæˆé£Ÿè°±
    recipe_markdown = generate_recipe(ingredients, cuisine_type, special_requirements)
    
    if recipe_markdown:
        # æå–èœå
        recipe_name = None
        lines = recipe_markdown.split('\n')
        for line in lines:
            if line.startswith('# '):
                recipe_name = line[2:].strip()
                break
        
        # ä¿å­˜é£Ÿè°±
        saved_file = save_recipe(recipe_markdown, recipe_name)
        
        # æ‰“å°é£Ÿè°±é¢„è§ˆ
        print("\nğŸ“ é£Ÿè°±é¢„è§ˆ:\n")
        preview_lines = recipe_markdown.split('\n')[:15]  # åªæ˜¾ç¤ºå‰15è¡Œ
        print("\n".join(preview_lines))
        print("...\n[å®Œæ•´é£Ÿè°±è¯·æŸ¥çœ‹ä¿å­˜çš„æ–‡ä»¶]")
    else:
        print("âŒ æ— æ³•ç”Ÿæˆé£Ÿè°±ï¼Œè¯·ç¨åå†è¯•ã€‚")
    
    print("\n" + "=" * 50)
    print("æ„Ÿè°¢ä½¿ç”¨ SmartChef!")
    print("=" * 50)

if __name__ == "__main__":
    main() 